<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Communication · Blink</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Blink</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Blink.jl Documentation</a></li><li><a class="tocitem" href="../guide/">Usage Guide</a></li><li class="is-active"><a class="tocitem" href>Communication</a><ul class="internal"><li><a class="tocitem" href="#Julia-to-Javascript"><span>Julia to Javascript</span></a></li><li><a class="tocitem" href="#Javascript-to-Julia"><span>Javascript to Julia</span></a></li><li><a class="tocitem" href="#Back-and-forth"><span>Back-and-forth</span></a></li><li><a class="tocitem" href="#Tasks"><span>Tasks</span></a></li></ul></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Communication</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Communication</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaGizmos/Blink.jl/blob/master/docs/src/communication.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Communication"><a class="docs-heading-anchor" href="#Communication">Communication between Julia and Javascript</a><a id="Communication-1"></a><a class="docs-heading-anchor-permalink" href="#Communication" title="Permalink"></a></h1><p>After creating a Window and loading HTML and JS, you may want to interact with julia code (e.g. by clicking a button in HTML, or displaying a plot from julia).</p><p>This section covers this two-way communication.</p><h2 id="Julia-to-Javascript"><a class="docs-heading-anchor" href="#Julia-to-Javascript">Julia to Javascript</a><a id="Julia-to-Javascript-1"></a><a class="docs-heading-anchor-permalink" href="#Julia-to-Javascript" title="Permalink"></a></h2><p>The easiest way to communicate to javascript from julia is with the <a href="../api/#JSExpr.@js"><code>@js</code></a> and <a href="../api/#Blink.@js_"><code>@js_</code></a> macros. These macros allow you to execute arbitrary javascript code in a given Window.</p><pre><code class="language-julia-repl">julia&gt; @js win x = 5;

julia&gt; @js win x
5</code></pre><p>The <code>@js_</code> macro executes its code asynchronously, but doesn&#39;t return its result:</p><pre><code class="language-julia-repl">julia&gt; @time @js win begin   # Blocks until finished; `i` is returned
         for i in 0:1000000 end  # waste time
         i  # return i
       end
  0.261568 seconds (64.78 k allocations: 3.331 MiB)
1000001

julia&gt; @time @js_ win begin   # Returns immediately, but `i` is not returned.
         for i in 0:1000000 end  # waste time
         i  # This is ignored
       end
  0.008359 seconds (3.84 k allocations: 227.879 KiB)
Page(1, WebSocket(server, CONNECTED), Dict{String,Any}(&quot;webio&quot; =&gt; Blink.AtomShell.var&quot;#22#23&quot;{Blink.AtomShell.WebIOBlinkComm}(Blink.AtomShell.WebIOBlinkComm(Window(1, Electron(Process(`/home/travis/build/JuliaGizmos/Blink.jl/deps/atom/electron /home/travis/build/JuliaGizmos/Blink.jl/src/AtomShell/main.js port 7474`, ProcessRunning), Sockets.TCPSocket(RawFD(0x00000016) active, 0 bytes waiting), Dict{String,Any}(&quot;callback&quot; =&gt; Blink.var&quot;#1#2&quot;())), Page(#= circular reference @-5 =#), Task (done) @0x00007f9e922e5600))),&quot;callback&quot; =&gt; Blink.var&quot;#1#2&quot;()), Distributed.Future(1, 1, 1, Some(true)))</code></pre><p>If your javascript expression is complex, or you want to copy-paste existing javascript, it can be easier to represent it as a pure javascript string. For that, you can call the <a href="../api/#Blink.js"><code>js</code></a> function with a <a href="../api/#WebIO.JSString"><code>JSString</code></a>:</p><pre><code class="language-julia-repl">julia&gt; body!(win, &quot;&quot;&quot;&lt;div id=&quot;box&quot; style=&quot;color:red;&quot;&gt;&lt;/div&gt;&quot;&quot;&quot;, async=false);

julia&gt; div_id = &quot;box&quot;;

julia&gt; js(win, Blink.JSString(&quot;&quot;&quot;document.getElementById(&quot;$div_id&quot;).style.color&quot;&quot;&quot;))
&quot;red&quot;</code></pre><p>Note that the code passed to these macros runs in its own scope, so any javascript variables you create with <code>var</code> (or the <code>@var</code> equivalent for <code>@js</code>) will be inaccessible after returning:</p><pre><code class="language-julia-repl">julia&gt; @js win (@var x_var = 5; x_var)  # x_var is only accessible within this scope.
5

julia&gt; @js win x_var
ERROR: Javascript error	ReferenceError: x_var is not defined</code></pre><h2 id="Javascript-to-Julia"><a class="docs-heading-anchor" href="#Javascript-to-Julia">Javascript to Julia</a><a id="Javascript-to-Julia-1"></a><a class="docs-heading-anchor-permalink" href="#Javascript-to-Julia" title="Permalink"></a></h2><p>Communication from javascript to julia currently works via a message passing interface.</p><p>To invoke julia code from javascript, you specify a julia callback via <code>handle</code>:</p><pre><code class="language-julia-repl">julia&gt; handle(w, &quot;press&quot;) do args
         @show args
       end</code></pre><p>This callback can then be triggered from javscript via <code>Blink.msg()</code>:</p><pre><code class="language-julia-repl">julia&gt; @js w Blink.msg(&quot;press&quot;, &quot;Hello from JS&quot;);
args = &quot;Hello from JS&quot;</code></pre><p>Note that the javascript function <code>Blink.msg</code> takes <em>exactly</em> 1 argument.  To pass more or fewer arguments, you must pass your arguments as an array from the JavaScript side (and optionally <em>destructure</em> them into variables on the Julia side):</p><pre><code class="language-julia-repl">julia&gt; handle(w, &quot;event1&quot;) do args  # This can accept an array of arguments
           @show args
       end
#3 (generic function with 1 method)

julia&gt; handle(w, &quot;event2&quot;) do (count, values, message)  # This will use the first 3 values from the passed array
           @show count, values, message
       end
#5 (generic function with 1 method)

julia&gt; @js w Blink.msg(&quot;event1&quot;, [1, [&#39;a&#39;,&#39;b&#39;], &quot;Hi&quot;]);
args = Any[1, Any[&quot;a&quot;, &quot;b&quot;], &quot;Hi&quot;]

julia&gt; @js w Blink.msg(&quot;event2&quot;, [1, [&#39;a&#39;,&#39;b&#39;], &quot;Hi&quot;]);
(count, values, message) = (1, Any[&quot;a&quot;, &quot;b&quot;], &quot;Hi&quot;)</code></pre><p>Finally, here is an example that uses a button to call back to julia:</p><pre><code class="language-julia-repl">julia&gt; handle(w, &quot;press&quot;) do arg
         println(arg)
       end
#1 (generic function with 1 method)

julia&gt; body!(w, &quot;&quot;&quot;&lt;button onclick=&#39;Blink.msg(&quot;press&quot;, &quot;HELLO&quot;)&#39;&gt;go&lt;/button&gt;&quot;&quot;&quot;, async=false);</code></pre><p>Now, clicking the button will print <code>HELLO</code> to julia&#39;s STDOUT.</p><h2 id="Back-and-forth"><a class="docs-heading-anchor" href="#Back-and-forth">Back-and-forth</a><a id="Back-and-forth-1"></a><a class="docs-heading-anchor-permalink" href="#Back-and-forth" title="Permalink"></a></h2><p>Note that you cannot make a synchronous call to javascript from <em>within</em> a julia callback, or you&#39;ll cause julia to hang:</p><p><strong>BAD</strong>:</p><pre><code class="language-julia-repl">julia&gt; @js w x = 5

julia&gt; handle(w, &quot;press&quot;) do args...
         # Increment x and get its new value
         x = @js w (x += 1; x)  # ERROR: Cannot make synchronous calls within a callback.
         println(&quot;New value: $x&quot;)
       end
#9 (generic function with 1 method)

julia&gt; @js w Blink.msg(&quot;press&quot;, [])

# JULIA HANGS UNTIL CTRL-C, WHICH KILLS YOUR BLINK WINDOW.</code></pre><p><strong>GOOD</strong>: Instead, if you need to access the value of <code>x</code>, you should simply provide it when invoking the <code>press</code> handler:</p><pre><code class="language-julia-repl">julia&gt; @js w x = 5
5

julia&gt; handle(w, &quot;press&quot;) do args...
         x = args[1]
         # Increment x
         @js_ w (x = $x + 1)  # Note the _asynchronous_ call.
         println(&quot;New value: $x&quot;)
       end
#3 (generic function with 1 method)

julia&gt; @js w Blink.msg(&quot;press&quot;, x)
New value: 5

julia&gt; # JULIA HANGS UNTIL CTRL-C, WHICH KILLS YOUR BLINK WINDOW.</code></pre><h2 id="Tasks"><a class="docs-heading-anchor" href="#Tasks">Tasks</a><a id="Tasks-1"></a><a class="docs-heading-anchor-permalink" href="#Tasks" title="Permalink"></a></h2><p>The julia webserver is implemented via Julia <a href="https://docs.julialang.org/en/v1/manual/control-flow/#man-tasks-1">Tasks</a>. This means that julia code invoked from javascript will run <em>sort of</em> in parallel to your main julia code.</p><p>In particular:</p><ul><li>Tasks are <em>coroutines, not threads</em>, so they aren&#39;t truly running in parallel.</li><li>Instead, execution can switch between your code and the coroutine&#39;s code whenever a piece of computation is <em>interruptible</em>.</li></ul><p>So, if your Blink callback handler performs uninterruptible work, it will fully occupy your CPU, preventing any other computation from occuring, and can potentially hang your computation.</p><h3 id="Examples:"><a class="docs-heading-anchor" href="#Examples:">Examples:</a><a id="Examples:-1"></a><a class="docs-heading-anchor-permalink" href="#Examples:" title="Permalink"></a></h3><p><strong>BAD</strong>: If your callback runs a long loop, it won&#39;t be uninterruptible while it&#39;s running:</p><pre><code class="language-julia-repl">julia&gt; handle(w, &quot;press&quot;) do args...
         println(&quot;Start&quot;)
         while true end  # infinite loop
         println(&quot;End&quot;)
       end
#40 (generic function with 1 method)

julia&gt; body!(w, &quot;&quot;&quot;&lt;button onclick=&#39;Blink.msg(&quot;press&quot;, 1)&#39;&gt;go&lt;/button&gt;&quot;&quot;&quot;, async=false);

julia&gt; # CLICK THE go BUTTON, AND YOUR PROCESS WILL FREEZE
Start</code></pre><p><strong>BAD</strong>: The same is true if your <em>main</em> julia computation is hogging the CPU, then your callback can&#39;t run:</p><pre><code class="language-julia-repl">julia&gt; handle(w, &quot;press&quot;) do args...
         println(&quot;Start&quot;)
         sleep(5) # This will happily yield to any other computation.
         println(&quot;End&quot;)
       end
#41 (generic function with 1 method)

julia&gt; body!(w, &quot;&quot;&quot;&lt;button onclick=&#39;Blink.msg(&quot;press&quot;, 1)&#39;&gt;go&lt;/button&gt;&quot;&quot;&quot;, async=false);

julia&gt; while true end  # Infinite loop

# NOW, CLICK THE go BUTTON, AND NOTHING HAPPENS, SINCE THE CPU IS BEING HOGGED!</code></pre><p><strong>GOOD</strong>: So to allow for happy communication, all your computations should be interruptible, which you can achieve with calls such as <code>yield</code>, or <code>sleep</code>:</p><pre><code class="language-julia-repl">julia&gt; handle(w, &quot;press&quot;) do args...
         println(&quot;Start&quot;)
         sleep(5) # This will happily yield to any other computation.
         println(&quot;End&quot;)
       end
#39 (generic function with 1 method)

julia&gt; body!(w, &quot;&quot;&quot;&lt;button onclick=&#39;Blink.msg(&quot;press&quot;, 1)&#39;&gt;go&lt;/button&gt;&quot;&quot;&quot;, async=false);

julia&gt; while true  # Still an infinite loop, but a _fair_ one.
         yield()  # This will yield to any other computation, allowing the callback to run.
       end

# NOW, CLICKING THE go BUTTON WILL WORK CORRECTLY ✅
Start
End</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../guide/">« Usage Guide</a><a class="docs-footer-nextpage" href="../api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 21 April 2021 15:20">Wednesday 21 April 2021</span>. Using Julia version 1.5.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
